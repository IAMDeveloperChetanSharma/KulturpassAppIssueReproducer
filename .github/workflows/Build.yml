name: Build
on:
  push:
    branches:
      - 'chore/ci-build-with-gha'

jobs:
  dependencies:
    runs-on: macos-13
    steps:
        - name: Check out repository code
          uses: actions/checkout@v3
        - uses: actions/setup-node@v3
          with:
            node-version: '18.16.0'
        - uses: ruby/setup-ruby@v1
          with:
            ruby-version: '3.2.1'
        - name: Restore Bundle Dependencies
          uses: actions/cache/restore@v3
          id: cache-bundle-dependencies
          env:
            cache-name: cache-bundle-dependencies-v1
          with:
            path: |
              vendor
              .bundle
            key: ${{ runner.os }}-${{ env.cache-name }}-${{ hashFiles('Gemfile.lock') }}       
        - name: Install Bundle Dependencies
          if: steps.cache-bundle-dependencies.outputs.cache-hit != 'true'
          run: bundle install
        - name: Save Bundle Dependencies
          uses: actions/cache/save@v3
          if: steps.cache-bundle-dependencies.outputs.cache-hit != 'true'
          env:
            cache-name: cache-bundle-dependencies-v1
          with:
            path: |
              vendor
              .bundle
            key: ${{ runner.os }}-${{ env.cache-name }}-${{ hashFiles('Gemfile.lock') }}
        - name: Restore Yarn Dependencies
          uses: actions/cache/restore@v3
          id: cache-yarn-dependencies
          env:
            cache-name: cache-yarn-dependencies-v1
          with:
            path: |
              node_modules
            key: ${{ runner.os }}-${{ env.cache-name }}-${{ hashFiles('yarn.lock') }}    
        - name: Install Yarn Dependencies
          if: steps.cache-yarn-dependencies.outputs.cache-hit != 'true'
          env:
            SAP_ARTIFACTORY_URL: ${{ secrets.SAP_ARTIFACTORY_URL }}
            SAP_ARTIFACTORY_TOKEN: ${{ secrets.SAP_ARTIFACTORY_TOKEN }}
          run: |
            bundle exec fastlane add_token_to_npmrc
            yarn install
        - name: Save Yarn Dependencies
          uses: actions/cache/save@v3
          if: steps.cache-yarn-dependencies.outputs.cache-hit != 'true'
          env:
            cache-name: cache-yarn-dependencies-v1
          with:
            path: |
              node_modules
            key: ${{ runner.os }}-${{ env.cache-name }}-${{ hashFiles('yarn.lock') }}
        - name: Restore Pod Dependencies
          uses: actions/cache/restore@v3
          id: cache-pod-dependencies
          env:
            cache-name: cache-pod-dependencies-v1
          with:
            path: |
              ios/Pods
            key: ${{ runner.os }}-${{ env.cache-name }}-${{ hashFiles('ios/Podfile.lock') }}
        - name: Install Pod Dependencies
          if: steps.cache-pod-dependencies.outputs.cache-hit != 'true'
          run: |
            cd ios
            NO_FLIPPER=1 bundle exec pod install"
        - name: Save Pod Dependencies
          uses: actions/cache/save@v3
          if: steps.cache-Pod-dependencies.outputs.cache-hit != 'true'
          env:
            cache-name: cache-pod-dependencies-v1
          with:
            path: |
              ios/Pods
            key: ${{ runner.os }}-${{ env.cache-name }}-${{ hashFiles('ios/Podfile.lock') }}
  build:
    runs-on: macos-13
    needs: dependencies
    steps:
        - name: Check out repository code
          uses: actions/checkout@v3
        - uses: actions/setup-node@v3
          with:
            node-version: '18.16.0'
        - uses: ruby/setup-ruby@v1
          with:
            ruby-version: '3.2.1'
        - name: Restore Bundle Dependencies
          uses: actions/cache/restore@v3
          id: cache-bundle-dependencies
          env:
            cache-name: cache-bundle-dependencies-v1
          with:
            path: |
              vendor
              .bundle
            key: ${{ runner.os }}-${{ env.cache-name }}-${{ hashFiles('Gemfile.lock') }}
        - name: Restore Yarn Dependencies
          uses: actions/cache/restore@v3
          id: cache-yarn-dependencies
          env:
            cache-name: cache-yarn-dependencies-v1
          with:
            path: |
              node_modules
            key: ${{ runner.os }}-${{ env.cache-name }}-${{ hashFiles('yarn.lock') }}
        - name: Restore Pod Dependencies
          uses: actions/cache/restore@v3
          id: cache-pod-dependencies
          env:
            cache-name: cache-pod-dependencies-v1
          with:
            path: |
              ios/Pods
            key: ${{ runner.os }}-${{ env.cache-name }}-${{ hashFiles('ios/Podfile.lock') }}
        - name: Build
          env:
            SAP_ARTIFACTORY_URL: ${{ secrets.SAP_ARTIFACTORY_URL }}
            SAP_ARTIFACTORY_TOKEN: ${{ secrets.SAP_ARTIFACTORY_TOKEN }}
          run: |
            bundle exec fastlane ios build
